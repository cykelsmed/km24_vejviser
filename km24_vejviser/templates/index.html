<!DOCTYPE html>
<html lang="da" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KM24 Vejviser</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <style>
        body {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        main.container {
            max-width: 800px;
        }
        #result h4, #result h5 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #333;
        }
        #result p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        #result ul {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        #result li {
            margin-bottom: 0.5em;
        }
        .power-tip {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .warning {
            background: #fff2e8;
            border-left: 4px solid #fa541c;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .geo-advice {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }

        /* NEW: Styles for KM24 validation warnings */
        .validation-warning {
            background: #fff2e8;
            border-left: 4px solid #fa541c;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .validation-warning ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .validation-warning li {
            margin-bottom: 0.25rem;
        }

        /* NEW: Styles for KM24 module suggestions */
        .km24-suggestions {
            background: #f0f5ff;
            border-left: 4px solid #1890ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            list-style: none;
        }
        .km24-suggestions li {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #d9d9d9;
        }
        .km24-suggestions strong {
            color: #1890ff;
        }
        .km24-suggestions em {
            color: #666;
            font-size: 0.9rem;
        }
        .km24-suggestions small {
            color: #999;
            font-size: 0.8rem;
        }
        #result {
            border: 1px solid var(--pico-muted-border-color);
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            margin-top: 1rem;
            min-height: 100px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #recipe-output {
            white-space: pre-wrap;
            background-color: #f7f7f7;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e1e1e1;
        }

        /* Styles for search string formatting */
        .search-string-container {
            position: relative;
            background-color: #f0f0f0; /* Lidt mørkere end #result baggrund */
            border-radius: var(--pico-border-radius);
            margin: 1rem 0;
            padding-top: 2.5rem; /* Plads til knappen */
        }
        .search-string-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 1rem;
            background-color: transparent;
            border: none;
        }
        .search-string-container .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            border: 1px solid var(--pico-muted-border-color);
        }
        .copy-btn.copied {
            background-color: #4CAF50; /* Grøn farve for "kopieret" feedback */
            color: white;
            border-color: #4CAF50;
        }

        /* Styles for inspiration prompts */
        .inspiration-container {
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .inspiration-prompt {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin: 0.25rem;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid var(--pico-muted-border-color);
            color: var(--pico-foreground);
            border-radius: 2rem;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .inspiration-prompt:hover {
            background-color: var(--pico-primary);
            color: var(--pico-primary-inverse);
            border-color: var(--pico-primary);
        }

        /* Styles for JSON rendering */
        .step {
            border: 1px solid var(--pico-muted-border-color);
            padding: 1rem 1.5rem;
            border-radius: var(--pico-border-radius);
            margin-bottom: 1rem;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--pico-primary);
        }
        .step-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0;
        }
        .step-details {
            margin-left: 3rem; /* Indent details */
        }
        .step-details strong {
            display: block;
            margin-top: 0.5rem;
        }

        .strategic-note, .notification-recommendation {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--pico-border-radius);
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .strategic-note {
            background-color: var(--pico-info-background);
            border-left: 4px solid var(--pico-info-border);
        }

        .notification-recommendation {
            background-color: var(--pico-warning-background);
            border-left: 4px solid var(--pico-warning-border);
        }

        .strategic-note svg, .notification-recommendation svg {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        /* Styles for geo advice */
        .geo-advice {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        /* Styles for power tip og supplementary modules */
        .power-tip {
            background: #fffbe6;
            border-left: 4px solid #faad14;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .supplementary-modules {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            list-style: none;
        }
        .supplementary-modules li {
            margin-bottom: 0.5rem;
        }

        /* Styles for new creative sections */
        .creative-approach {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .potential-story-angles {
            background: #fff2e8;
            border-left: 4px solid #fa541c;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        .creative-cross-references {
            background: #f0f5ff;
            border-left: 4px solid #2f54eb;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 8px;
        }

        .creative-insights {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            font-style: italic;
        }

        .advanced-tactics {
            background: #fff7e6;
            border-left: 4px solid #fa8c16;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
        }

        .search-examples {
            background: #f9f0ff;
            border-left: 4px solid #722ed1;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
        }

        .live-data-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #e6f7ff;
            color: #1890ff;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .live-data-indicator::before {
            content: "●";
            color: #52c41a;
            font-size: 1.2rem;
        }

        /* NEW: Enhanced Module Cards */
        .enhanced-module-card {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #d9d9d9;
            position: relative;
        }

        .module-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .module-emoji {
            font-size: 1.5rem;
        }

        .module-info {
            flex: 1;
        }

        .module-title {
            font-weight: bold;
            margin: 0;
        }

        .module-frequency {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
        }

        .complexity-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .complexity-simpel {
            background-color: #52c41a;
            color: white;
        }

        .complexity-medium {
            background-color: #fa8c16;
            color: white;
        }

        .complexity-kompleks {
            background-color: #f5222d;
            color: white;
        }

        /* Module Statistics */
        .module-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #666;
            margin: 0.75rem 0;
            flex-wrap: wrap;
        }

        .module-stats span {
            background: rgba(255,255,255,0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .complexity-simpel {
            background: #f6ffed;
            color: #52c41a;
        }

        .complexity-medium {
            background: #fff7e6;
            color: #fa8c16;
        }

        .complexity-kompleks {
            background: #fff2e8;
            color: #fa541c;
        }

        /* External Links */
        .external-link {
            color: #1890ff !important;
            text-decoration: underline;
            font-weight: 500;
        }

        .external-link:hover {
            color: #40a9ff !important;
        }

        /* Long Description Details */
        .enhanced-module-card details {
            margin-top: 1rem;
        }

        .enhanced-module-card summary {
            cursor: pointer;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 0.5rem;
        }

        .enhanced-module-card summary:hover {
            color: #40a9ff;
        }

        .enhanced-module-card details[open] summary {
            margin-bottom: 0.75rem;
        }

        /* Filter Recommendations */
        .filter-recommendations {
            background: #f0f5ff;
            border-left: 4px solid #1890ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }

        .filter-sequence {
            list-style: none;
            padding: 0;
        }

        .filter-sequence li {
            padding: 0.25rem 0;
            border-bottom: 1px solid #e6f7ff;
        }

        .filter-sequence li:last-child {
            border-bottom: none;
        }

        /* Complexity Analysis */
        .complexity-analysis {
            background: #fff7e6;
            border-left: 4px solid #fa8c16;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }

        .complexity-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .efficiency-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .efficiency-high { background: #f6ffed; color: #52c41a; }
        .efficiency-medium { background: #fff7e6; color: #fa8c16; }
        .efficiency-low { background: #fff2e8; color: #fa541c; }

        /* Search Optimization */
        .search-optimization {
            background: #f9f0ff;
            border-left: 4px solid #722ed1;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }

        .optimal-config {
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Cross-Module Intelligence */
        .cross-module-intelligence {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 8px;
        }

        .workflow-chain {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
            font-weight: bold;
        }

        .workflow-arrow {
            color: #1890ff;
            font-size: 1.2rem;
        }

        /* Module Availability Matrix */
        .availability-matrix {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 8px;
        }

        .matrix-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #52c41a;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>KM24 Vejviser</h1>
            <p class="lead">Din guide til datadrevet journalistik</p>
        </header>
        <form id="recipe-form">
            <label for="goal">Beskriv dit journalistiske mål eller dækningsområde:</label>
            <textarea id="goal" name="goal" rows="5" required placeholder="Jeg vil gerne undersøge, hvem der systematisk opkøber ejendomme i Skagen-området... (minimum 10 tegn)"></textarea>
            
            {% if prompts %}
            <div class="inspiration-container">
                <small>Eller start med et eksempel:</small><br>
                {% for p in prompts %}
                <button type="button" class="inspiration-prompt" data-prompt="{{ p.prompt }}">{{ p.title }}</button>
                {% endfor %}
            </div>
            {% endif %}

            <button type="submit" aria-busy="false">Generér Opskrift</button>
        </form>
        <section>
            <h2>Din Opskrift:</h2>
            <div id="result">
                <p>Resultatet af din forespørgsel vil blive vist her.</p>
            </div>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing script');
            const form = document.getElementById('recipe-form');
            const resultDiv = document.getElementById('result');
            const submitButton = form.querySelector('button[type="submit"]');
            console.log('Form found:', form);
            console.log('Submit button found:', submitButton);
            console.log('Submit button type:', submitButton ? submitButton.type : 'null');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Form submitted - event prevented');
                const goalField = document.getElementById('goal');
                console.log('Goal field found:', goalField);
                const goal = goalField ? goalField.value : '';
                console.log('Goal value:', goal);
                console.log('Goal length:', goal.length);
                console.log('Goal field type:', typeof goalField);
                console.log('Goal field value type:', typeof goal);
                
                // Valider input længde
                if (goal.length < 10) {
                    document.getElementById('result').innerHTML = `<p style="color: red;"><strong>Fejl:</strong> Dit mål skal være mindst 10 tegn langt. Du har skrevet ${goal.length} tegn.</p>`;
                    return;
                }
                
                submitButton.setAttribute('aria-busy', 'true');
                submitButton.disabled = true;
                document.getElementById('result').innerHTML = '<div class="loading"><progress></progress></div>';

                try {
                    const response = await fetch('/generate-recipe/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ goal: goal })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    const jsonData = await response.json();
                    console.log('JSON Data received:', jsonData);
                    renderJsonResponse(jsonData);

                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('result').innerHTML = `<p style="color: red;"><strong>Fejl:</strong> ${error.message}</p>`;
                } finally {
                    submitButton.setAttribute('aria-busy', 'false');
                    submitButton.disabled = false;
                }
            });

            // Debug inspiration prompts
            const inspirationButtons = document.querySelectorAll('.inspiration-prompt');
            console.log('Found inspiration buttons:', inspirationButtons.length);
            console.log('Inspiration buttons:', inspirationButtons);
            
            inspirationButtons.forEach((button, index) => {
                console.log(`Button ${index}:`, button.textContent, button.getAttribute('data-prompt'));
                console.log(`Button ${index} element:`, button);
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Inspiration prompt clicked - event prevented');
                    const prompt = button.getAttribute('data-prompt');
                    console.log('Prompt:', prompt);
                    const goalField = document.getElementById('goal');
                    console.log('Goal field found:', goalField);
                    if (goalField) {
                        goalField.value = prompt;
                        console.log('Goal field value set to:', goalField.value);
                        console.log('Goal field value after setting:', document.getElementById('goal').value);
                    } else {
                        console.error('Goal field not found!');
                    }
                });
            });

            function renderJsonResponse(data) {
                console.log('renderJsonResponse called with:', data);
                
                // Defensive check for data
                if (!data || typeof data !== 'object') {
                    console.error('Invalid data received:', data);
                    document.getElementById('result').innerHTML = '<p style="color: red;"><strong>Fejl:</strong> Ugyldig data modtaget fra serveren.</p>';
                    return;
                }
                
                console.log('Data keys:', Object.keys(data));
                console.log('Steps/investigation_steps:', data.steps, data.investigation_steps);
                
                // Handle both old and new data structures
                const title = data.title || data.overview?.title || 'Ingen titel';
                const strategy = data.strategy_summary || data.overview?.strategy_summary || 'Ingen strategi';
                const creativeApproach = data.creative_approach || data.overview?.creative_approach;
                
                let html = `<h4>${title}</h4>`;
                html += `<p><strong>Strategi:</strong> ${strategy}</p>`;
                
                if (creativeApproach) {
                    html += `<div class="creative-approach">`;
                    html += `<h4>🎨 Kreativ Tilgang</h4>`;
                    html += `<p>${creativeApproach}</p>`;
                    html += `</div>`;
                }

                // Defensive check for steps
                const steps = data.steps || data.investigation_steps || [];
                console.log('Steps array:', steps);
                console.log('Steps type:', typeof steps);
                console.log('Steps length:', steps.length);
                
                if (!Array.isArray(steps)) {
                    console.error('Steps is not an array:', steps);
                    html += '<p style="color: red;"><strong>Fejl:</strong> Steps data er ikke i korrekt format.</p>';
                } else {
                    steps.forEach(step => {
                    html += `
                        <div class="step">
                            <div class="step-header">
                                <span class="step-number">${step.step_number || step.step}</span>
                                <h5 class="step-title">${step.title}</h5>
                            </div>
                            <div class="step-details">`;
                    
                    // Enhanced Module Card with Long Description & Statistics
                    if (step.details && step.details.module_card) {
                        const card = step.details.module_card;

                        // Parse HTML links in long description
                        const longDescHtml = card.long_description ?
                            card.long_description.replace(
                                /<a href="([^"]+)"[^>]*>([^<]+)<\/a>/g,
                                '<a href="$1" target="_blank" rel="noopener noreferrer" class="external-link">$2 ↗</a>'
                            ) : '';

                        // Use backend-calculated statistics
                        const filterCount = card.total_filters || 0;
                        const complexityText = card.complexity_level || 'Ukendt';
                        const multiSelectCount = card.available_filters ?
                            card.available_filters.filter(f => f.multiple).length : 0;
                        const filterTypes = card.available_filters ?
                            [...new Set(card.available_filters.map(f => f.type))].join(', ') : '';

                        // Determine complexity CSS class based on backend complexity level
                        let complexityClass = 'complexity-simpel';
                        if (complexityText === 'Kompleks') {
                            complexityClass = 'complexity-kompleks';
                        } else if (complexityText === 'Medium') {
                            complexityClass = 'complexity-medium';
                        }

                        const moduleName = step.module?.name || step.module || 'Ukendt modul';

                        console.log('Module card debug:', {
                            module: moduleName,
                            totalFilters: filterCount,
                            complexityLevel: complexityText,
                            longDescription: card.long_description ? 'PRESENT' : 'MISSING'
                        });

                        html += `
                            <div class="enhanced-module-card" style="border-left-color: ${card.color};">
                                <div class="module-header">
                                    <span class="module-emoji">${card.emoji}</span>
                                    <div class="module-info">
                                        <h6 class="module-title">${moduleName}</h6>
                                        <p class="module-frequency">📊 ${card.data_frequency}</p>
                                    </div>
                                    <span class="complexity-badge ${complexityClass}">${complexityText}</span>
                                </div>

                                <p class="module-description">${card.short_description}</p>

                                <div class="module-stats">
                                    <span>🎛️ ${filterCount} filtre</span>
                                    <span>✅ ${multiSelectCount} multi-select</span>
                                    <span>🔧 ${filterTypes || 'Ingen filtre'}</span>
                                </div>

                                ${longDescHtml ? `
                                    <details open style="margin-top: 1rem;">
                                        <summary style="cursor: pointer; font-weight: bold;">📖 Læs mere om ${moduleName}</summary>
                                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e6e6e6; font-size: 0.9rem; line-height: 1.5;">
                                            ${longDescHtml}
                                        </div>
                                    </details>
                                ` : ''}

                                ${card.requires_source_selection ? '<p style="margin-top: 0.5rem;"><strong>⚠️ Kræver manuel kildevalg</strong></p>' : ''}
                            </div>`;
                    } else if (step.module) {
                        const moduleName = step.module?.name || step.module || 'Ukendt modul';
                        html += `<p><strong>Modul:</strong> <em>${moduleName}</em></p>`;
                    }
                    
                    html += `<p><strong>Formål:</strong> ${step.rationale}</p>`;
                    
                    const details = step.details || {};
                    if (details.strategic_note) {
                            html += `
                                <div class="strategic-note">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-1.233-3.654-2.11M12 18.75v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.311a7.5 7.5 0 0 1-7.5 0c-1.421-.492-2.682-1.233-3.654-2.11m-9.58 3.28a13.5 13.5 0 0 1 2.083-1.611m-2.083 1.611a13.5 13.5 0 0 0 2.083-1.611M3.75 6.75A2.25 2.25 0 0 1 6 4.5h12A2.25 2.25 0 0 1 20.25 6.75v10.5A2.25 2.25 0 0 1 18 19.5H6A2.25 2.25 0 0 1 3.75 17.25V6.75Z" /></svg>
                                    <div>${details.strategic_note}</div>
                                </div>`;
                        }

                        if (details.search_string) {
                             html += `
                                <strong>Søgestreng:</strong>
                                <div class="search-string-container">
                                    <button class="copy-btn">Kopiér</button>
                                    <pre><code>${details.search_string}</code></pre>
                                </div>
                                <strong>Forklaring:</strong>
                                <p>${details.explanation || step.explanation || ''}</p>`;
                        }

                        if (details.logic) {
                            html += `<strong>Logik:</strong> <p>${details.logic}</p>`;
                        }
                        
                        if(details.recommended_notification) {
                            const notificationText = details.recommended_notification === 'løbende'
                                ? '<b>Løbende notifikation:</b> Få besked med det samme, når der er nye resultater. Godt til tidskritiske overvågninger.'
                                : '<b>Interval notifikation:</b> Få en samlet besked dagligt eller ugentligt. Godt til mindre presserende overvågninger for at undgå støj.';
                            html += `
                                <div class="notification-recommendation">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg>
                                    <div>${notificationText}</div>
                                </div>`;
                        }
                        
                        // Add new creative sections
                        if (details.creative_insights) {
                            html += `<div class="creative-insights"><strong>💡 Kreativ Indsigt:</strong> ${details.creative_insights}</div>`;
                        }
                        
                        if (details.advanced_tactics) {
                            html += `<div class="advanced-tactics"><strong>🎯 Avancerede Taktikker:</strong> ${details.advanced_tactics}</div>`;
                        }
                        
                        if (details.search_examples && Array.isArray(details.search_examples) && details.search_examples.length > 0) {
                            html += `<div class="search-examples"><strong>🔍 Søge-eksempler:</strong><ul>${details.search_examples.map(ex => `<li><code>${ex}</code></li>`).join('')}</ul></div>`;
                        }
                        
                        // Filter Recommendations
                        if (details.filter_recommendations) {
                            const rec = details.filter_recommendations;
                            html += `<div class="filter-recommendations">`;
                            html += `<h6>🔧 Smart Filter-anbefaling</h6>`;
                            if (rec.optimal_sequence && Array.isArray(rec.optimal_sequence) && rec.optimal_sequence.length > 0) {
                                html += `<p><strong>Optimal rækkefølge:</strong></p>`;
                                html += `<ol class="filter-sequence">`;
                                rec.optimal_sequence.forEach(seq => {
                                    html += `<li>${seq}</li>`;
                                });
                                html += `</ol>`;
                            }
                            if (rec.complexity_warning) {
                                html += `<p><strong>⚠️ Advarsel:</strong> ${rec.complexity_warning}</p>`;
                            }
                            if (rec.efficiency_tips && Array.isArray(rec.efficiency_tips) && rec.efficiency_tips.length > 0) {
                                html += `<p><strong>💡 Tips:</strong> ${rec.efficiency_tips.slice(0,2).join('. ')}</p>`;
                            }
                            html += `</div>`;
                        }

                        // Complexity Analysis
                        if (details.complexity_analysis) {
                            const comp = details.complexity_analysis;
                            html += `<div class="complexity-analysis">`;
                            html += `<h6>📊 Kompleksitets-analyse</h6>`;
                            html += `<div class="complexity-score">`;
                            html += `<span><strong>Forventede hits:</strong> ${comp.estimated_hits}</span>`;
                            const efficiencyClass = comp.filter_efficiency.includes('Høj') ? 'efficiency-high' : 
                                                  comp.filter_efficiency.includes('Medium') ? 'efficiency-medium' : 'efficiency-low';
                            html += `<span class="efficiency-badge ${efficiencyClass}">${comp.filter_efficiency}</span>`;
                            html += `</div>`;
                            if (comp.notification_recommendation) {
                                html += `<p><strong>Notifikation:</strong> ${comp.notification_recommendation.type} - ${comp.notification_recommendation.reason}</p>`;
                            }
                            if (comp.optimization_suggestions && Array.isArray(comp.optimization_suggestions) && comp.optimization_suggestions.length > 0) {
                                html += `<p><strong>💡 Optimering:</strong> ${comp.optimization_suggestions[0]}</p>`;
                            }
                            html += `</div>`;
                        }

                        // Search Optimization
                        if (details.search_optimization && details.search_optimization.optimal_config) {
                            const opt = details.search_optimization;
                            html += `<div class="search-optimization">`;
                            html += `<h6>🎯 Optimal Konfiguration</h6>`;
                            html += `<p>${opt.rationale}</p>`;
                            html += `<div class="optimal-config">`;
                            if (opt.optimal_config && typeof opt.optimal_config === 'object') {
                                Object.entries(opt.optimal_config).forEach(([key, value]) => {
                                    const displayValue = Array.isArray(value) ? value.join(', ') : value;
                                    html += `<strong>${key}:</strong> ${displayValue}<br>`;
                                });
                            }
                            html += `</div>`;
                            html += `</div>`;
                        }

                        if (details.live_data_available) {
                            html += `<div class="live-data-indicator">${details.data_source || 'Live data tilgængelig'}</div>`;
                        }
                        
                        if (details.geo_advice) {
                            html += `
                                <div class="geo-advice">
                                    🌍 <strong>Geo-råd:</strong> ${details.geo_advice}
                                </div>
                            `;
                        }
                        if (details.power_tip) {
                            html += `
                                <div class="power-tip">
                                    ⚡ <strong>${details.power_tip.title}:</strong> ${details.power_tip.explanation}
                                </div>
                            `;
                        }
                    } else if (step.type === 'manual_research') {
                        html += `<strong>Forventet output:</strong> <p>${step.output}</p>`;
                    }
                    
                    html += `</div></div>`;
                });
                } // End of else block for Array.isArray(steps)

                if (data.next_level_questions && Array.isArray(data.next_level_questions) && data.next_level_questions.length > 0) {
                    html += `<h4>Næste Niveau</h4><ul>`;
                    data.next_level_questions.forEach(q => {
                        html += `<li>${q}</li>`;
                    });
                    html += `</ul>`;
                }

                if (data.supplementary_modules && Array.isArray(data.supplementary_modules) && data.supplementary_modules.length > 0) {
                    html += `<h4>Supplerende moduler at overveje</h4><ul class="supplementary-modules">`;
                    data.supplementary_modules.forEach(mod => {
                        html += `<li><strong>${mod.module}</strong>: ${mod.reason}</li>`;
                    });
                    html += `</ul>`;
                }

                // NEW: KM24 Module Validation Warnings
                if (data.validation_warnings && Array.isArray(data.validation_warnings) && data.validation_warnings.length > 0) {
                    html += `<h4>⚠️ KM24 Modul Validering</h4>`;
                    data.validation_warnings.forEach(warning => {
                        html += `<div class="validation-warning">`;
                        html += `<p><strong>${warning.message}</strong></p>`;
                        if (warning.suggestions && Array.isArray(warning.suggestions) && warning.suggestions.length > 0) {
                            html += `<p><strong>Forslag til alternative moduler:</strong></p><ul>`;
                            warning.suggestions.forEach(suggestion => {
                                html += `<li><strong>${suggestion.module}</strong> (${Math.round(suggestion.confidence * 100)}% match): ${suggestion.reason}</li>`;
                            });
                            html += `</ul>`;
                        }
                        html += `</div>`;
                    });
                }

                // NEW: KM24 Module Suggestions
                if (data.km24_module_suggestions && Array.isArray(data.km24_module_suggestions) && data.km24_module_suggestions.length > 0) {
                    html += `<h4>🔍 KM24 Modul Forslag</h4>`;
                    html += `<p>Baseret på dit mål foreslår vi følgende KM24 moduler:</p>`;
                    html += `<ul class="km24-suggestions">`;
                    data.km24_module_suggestions.forEach(suggestion => {
                        html += `<li>`;
                        html += `<strong>${suggestion.module}</strong> (${Math.round(suggestion.confidence * 100)}% relevans)`;
                        html += `<br><em>${suggestion.reason}</em>`;
                        if (suggestion.description) {
                            html += `<br><small>${suggestion.description}</small>`;
                        }
                        html += `</li>`;
                    });
                    html += `</ul>`;
                }

                // NEW: Creative Approach (already handled above)
                // Removed duplicate handling

                // NEW: Potential Story Angles
                if (data.potential_story_angles && Array.isArray(data.potential_story_angles) && data.potential_story_angles.length > 0) {
                    html += `<div class="potential-story-angles">`;
                    html += `<h4>📰 Potentielle Historievinkler</h4>`;
                    html += `<ul>`;
                    data.potential_story_angles.forEach(angle => {
                        html += `<li>${angle}</li>`;
                    });
                    html += `</ul>`;
                    html += `</div>`;
                }

                // NEW: Creative Cross References
                if (data.creative_cross_references && Array.isArray(data.creative_cross_references) && data.creative_cross_references.length > 0) {
                    html += `<div class="creative-cross-references">`;
                    html += `<h4>🔗 Kreative Krydsrefereringer</h4>`;
                    html += `<ul>`;
                    data.creative_cross_references.forEach(ref => {
                        html += `<li>${ref}</li>`;
                    });
                    html += `</ul>`;
                    html += `</div>`;
                }

                // Cross-Module Intelligence
                if (data.cross_module_intelligence && Array.isArray(data.cross_module_intelligence) && data.cross_module_intelligence.length > 0) {
                    html += `<div class="cross-module-intelligence">`;
                    html += `<h4>🔗 Smart Modul-workflows</h4>`;
                    html += `<p>Disse moduler fungerer godt sammen i din undersøgelse:</p>`;
                    data.cross_module_intelligence.forEach(rel => {
                        html += `<div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 6px;">`;
                        html += `<div class="workflow-chain">`;
                        html += `<strong>${rel.primary}</strong>`;
                        html += `<span class="workflow-arrow">→</span>`;
                        html += `<strong>${rel.connects_to.join(' & ')}</strong>`;
                        html += `</div>`;
                        html += `<p><strong>Workflow:</strong> ${rel.workflow}</p>`;
                        html += `<p><strong>Timing:</strong> ${rel.timing}</p>`;
                        html += `<p><strong>Hvorfor:</strong> ${rel.rationale}</p>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                }

                // Module Availability Matrix
                if (data.module_availability_matrix) {
                    const matrix = data.module_availability_matrix;
                    html += `<div class="availability-matrix">`;
                    html += `<h4>📊 KM24 Platform Oversigt</h4>`;
                    html += `<p>Komplet oversigt over modulernes funktioner:</p>`;
                    html += `<div class="matrix-stats">`;
                    
                    html += `<div class="stat-item">`;
                    html += `<span class="stat-number">${matrix.total_modules}</span>`;
                    html += `<div class="stat-label">Total moduler</div>`;
                    html += `</div>`;
                    
                    html += `<div class="stat-item">`;
                    html += `<span class="stat-number">${matrix.has_industry_filter}</span>`;
                    html += `<div class="stat-label">Med branche-filter</div>`;
                    html += `</div>`;
                    
                    html += `<div class="stat-item">`;
                    html += `<span class="stat-number">${matrix.has_municipality_filter}</span>`;
                    html += `<div class="stat-label">Med kommune-filter</div>`;
                    html += `</div>`;
                    
                    html += `<div class="stat-item">`;
                    html += `<span class="stat-number">${matrix.requires_source_selection}</span>`;
                    html += `<div class="stat-label">Kræver kildevalg</div>`;
                    html += `</div>`;
                    
                    html += `</div>`;
                    
                    if (matrix.modules_without_industry_filter && matrix.modules_without_industry_filter.length > 0) {
                        html += `<details open style="margin-top: 1rem;">`;
                        html += `<summary>Moduler uden branche-filter (${matrix.modules_without_industry_filter.length})</summary>`;
                        html += `<p style="margin-top: 0.5rem; font-size: 0.9rem;">${matrix.modules_without_industry_filter.join(', ')}</p>`;
                        html += `</details>`;
                    }
                    
                    html += `</div>`;
                }

                console.log('Setting innerHTML with html length:', html.length);
                document.getElementById('result').innerHTML = html;
                addCopyFunctionality();
            }

            function addCopyFunctionality() {
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const container = button.closest('.search-string-container');
                        const code = container.querySelector('code');
                        navigator.clipboard.writeText(code.textContent).then(() => {
                            button.textContent = 'Kopieret!';
                            button.classList.add('copied');
                            setTimeout(() => {
                                button.textContent = 'Kopiér';
                                button.classList.remove('copied');
                            }, 2000);
                        });
                    });
                });
            }
        });
    </script>
</body>
</html> 